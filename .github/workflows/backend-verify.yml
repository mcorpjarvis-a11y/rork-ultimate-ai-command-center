name: Backend Verification

on:
  push:
    branches: [ main, develop, 'copilot/**' ]
    paths:
      - 'backend/**'
      - 'services/**'
      - 'scripts/verify-backend-isolated.js'
      - '.github/workflows/backend-verify.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'backend/**'
      - 'services/**'
      - 'scripts/verify-backend-isolated.js'

jobs:
  verify-backend-isolation:
    name: Verify Backend Isolation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Lint backend code
        run: npm run lint
        continue-on-error: true
      
      - name: Run backend verification
        run: npm run verify:backend
        env:
          CI: true
      
      - name: Check for DOM types leakage
        run: |
          echo "Checking backend tsconfig.json for DOM lib..."
          if grep -q '"DOM"' backend/tsconfig.json; then
            echo "❌ ERROR: DOM lib found in backend/tsconfig.json"
            echo "Backend should not include DOM types to prevent browser API leakage"
            exit 1
          else
            echo "✅ OK: No DOM lib in backend/tsconfig.json"
          fi
      
      - name: Test production startup
        run: |
          echo "Starting backend in production mode..."
          timeout 15s npm run start:backend:prod &
          PID=$!
          sleep 5
          
          # Check if process is still running
          if kill -0 $PID 2>/dev/null; then
            echo "✅ Backend started successfully in production mode"
            kill $PID
            exit 0
          else
            echo "❌ Backend failed to start in production mode"
            exit 1
          fi
        env:
          PORT: 3001
          HOST: localhost
