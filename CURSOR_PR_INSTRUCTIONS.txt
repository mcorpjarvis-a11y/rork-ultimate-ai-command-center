
==========================
CURSOR AI PR BRIEF — ONE-SHOT IMPLEMENTATION
UNIVERSAL AUTH & CONNECTIONS HUB (SINGLE-USER, ANDROID/TERMUX/EXPO-ONLY)
==========================

Generated: 2025-11-08T00:29:16.541805Z

READ THIS FIRST
---------------
This repository targets Android only and must be fully functional on:
- Android via Expo Go (PKCE OAuth 2.0)
- Android APK (release)
- Termux (headless Node runtime with OAuth 2.0 Device Flow when supported)

iOS/Apple is NOT supported. Do NOT scaffold, repair, or reference iOS code. Respect the existing Apple-block script.

OBJECTIVE
---------
Implement a production-ready, single-user, local-first authentication & connection system that eliminates manual API keys. The app flow:
1) First launch → "Sign in with Google" → create local Master Profile.
2) Dashboard → "Connections Hub" grid → connect providers (AI, social, productivity, and smart home).
3) Tokens stored securely on-device and refreshed automatically.
4) All services get tokens through AuthManager. Zero direct env-key usage remains.
5) Tests cover TokenVault, AuthManager, MasterProfile, ConnectionsHub, and provider helpers (mocks).
6) APK build runs onboarding → dashboard → connections without runtime errors.

ABSOLUTE ENFORCEMENT (PR MUST FAIL IF ANY BROKEN)
--------------------------------------------------
- No secrets committed to repo (client secrets, access tokens).
- No iOS support added or re-enabled.
- All tests in /tests/auth/ pass.
- Android build + Expo Go run succeed.
- Termux device-flow login verified for providers that support it.
- All modified files have explicit .js extensions for local imports (ESM).

PLATFORMS & FLOWS
-----------------
- Expo Go (Android): use `expo-auth-session` PKCE for OAuth 2.0 (where supported).
- Termux (Android): use OAuth 2.0 Device Flow. If a provider does NOT support device flow, provide a CLI prompt to open the consent URL on another device and paste code back (installed app flow alternatives where allowed).

CORE MODULES (ALREADY SCAFFOLDED IN REPO OR TO BE CREATED)
----------------------------------------------------------
- services/auth/AuthManager.ts
  - startAuthFlow(provider), getAccessToken(provider), refreshAccessToken(provider), revokeProvider(provider)
  - getConnectedProviders(), isConnected(provider), event bus (connected/disconnected/token_refreshed)

- services/auth/TokenVault.ts
  - saveToken(provider, { access_token, refresh_token?, expiry?, scopes? })
  - getToken(provider), removeToken(provider), listProviders()

- services/auth/MasterProfile.ts
  - getMasterProfile(), saveMasterProfile(profile), clearMasterProfile()

- services/auth/providerHelpers/*.ts
  - One per provider with real endpoints and flows described below.

- components/ConnectionsHub.tsx
  - Grid of provider tiles → connect/disconnect → status

- screens/Onboarding/SignInScreen.tsx
  - First-run Google sign-in → create Master Profile → navigate to Dashboard

PROVIDERS & REAL ENDPOINTS
--------------------------
Implement provider helpers with real token endpoints & scopes (NO secrets). Where needed, use PKCE (mobile) or Device Flow (Termux).

1) Google (OIDC + APIs like Drive/YouTube/Gmail as needed)
   - Auth (PKCE): https://accounts.google.com/o/oauth2/v2/auth
   - Token: https://oauth2.googleapis.com/token
   - Revoke: https://oauth2.googleapis.com/revoke
   - Scopes: "openid email profile" (+ add Drive/YouTube scopes if used)
   - Notes: PKCE for mobile; Device Flow is supported for some APIs but spotty; fallback to manual consent flow if needed.

2) Hugging Face
   - OAuth App docs: https://huggingface.co/docs
   - Token Endpoint: https://huggingface.co/oauth/token
   - Scope: typically "read" for model access
   - Supports PAT as alternative (dev only). Prefer OAuth in app.

3) Google AI / Gemini
   - API docs: https://ai.google.dev/
   - Authentication generally via Google OAuth; reuse Google helper but request Gemini scopes where applicable (if available).

4) Instagram (Facebook Graph)
   - OAuth: https://www.facebook.com/v17.0/dialog/oauth
   - Token: https://graph.facebook.com/v17.0/oauth/access_token
   - Scopes: instagram_basic, pages_show_list, instagram_manage_insights (depending on features)
   - Notes: App review may be needed for production.

5) Discord
   - Auth: https://discord.com/api/oauth2/authorize
   - Token: https://discord.com/api/oauth2/token
   - Revoke: https://discord.com/api/oauth2/token/revoke
   - Scopes: identify, email, guilds (as needed)

6) Reddit (installed app)
   - Auth: https://www.reddit.com/api/v1/authorize
   - Token: https://www.reddit.com/api/v1/access_token
   - Scope: identity, read, submit (as needed)
   - Notes: Device Flow alternative: "installed app" grants; use PKCE where possible.

7) Spotify
   - Auth: https://accounts.spotify.com/authorize
   - Token: https://accounts.spotify.com/api/token
   - Scopes: user-read-email, user-read-private, playlist-modify-public (as needed)
   - Notes: Device Flow not official; fallback to out-of-app consent and code paste if needed.

8) X (Twitter)
   - OAuth 2.0 (PKCE): https://twitter.com/i/oauth2/authorize
   - Token: https://api.twitter.com/2/oauth2/token
   - Scopes: tweet.read, users.read, offline.access, tweet.write (as needed)
   - Notes: Device Flow not standard; use PKCE flow. Requires app registration.

9) YouTube (Google)
   - Reuse Google helper with YouTube scopes: https://www.googleapis.com/auth/youtube.readonly (etc.)

10) GitHub
   - Device Code: https://github.com/login/device
   - OAuth: https://github.com/login/oauth/authorize
   - Token: https://github.com/login/oauth/access_token
   - Scopes: read:user, repo (as needed)

11) Slack
   - Auth: https://slack.com/oauth/v2/authorize
   - Token: https://slack.com/api/oauth.v2.access
   - Scopes: users:read, chat:write, channels:read (as needed)

12) Notion
   - Auth: https://api.notion.com/v1/oauth/authorize
   - Token: https://api.notion.com/v1/oauth/token

SMART HOME PROVIDERS
--------------------
A) Home Assistant
   - Local access: Long-Lived Access Tokens (LLAT) via user profile in HA UI (dev alternative)
   - OAuth2 (if using Nabu Casa / addons); otherwise LLAT is the realistic path for local controller
   - API: http://homeassistant.local:8123/api; Auth: Bearer {token}

B) Tuya
   - Cloud OAuth: region endpoints (e.g., https://openapi.tuyaus.com)
   - Docs: https://developer.tuya.com/en/docs/cloud/oau

C) Philips Hue
   - Local bridge pairing (link button) → token saved; API is local to bridge

D) Alexa Smart Home
   - Account linking via Amazon Dev Console
   - Docs: https://developer.amazon.com/en-US/docs/alexa/smarthome/understand-account-linking.html

E) Google Home
   - Account linking via Google Actions (many routes deprecated/moved); keep optional

Connections Hub MUST support OAuth mode and Local Token mode (for HA/Hue).

CONNECTIONS HUB — REAL LOGIC
----------------------------
- Tile → connect → AuthManager.startAuthFlow(provider).
- Success → TokenVault.saveToken; MasterProfile.connectedProviders add provider.
- Disconnect → revokeProvider → remove from TokenVault and MasterProfile.
- Smart-home: Provide "Add Local Token" wizard that stores token with the provider.

MASTER PROFILE
--------------
interface MasterProfile { id: string; name?: string; email?: string; avatar?: string; createdAt: string; connectedProviders: string[]; }

TESTS (MANDATORY) — RUN AFTER EACH STEP
---------------------------------------
- TokenVault.test.ts
- AuthManager.test.ts
- MasterProfile.test.ts
- ConnectionsHub.test.tsx
- ProviderHelpers.test.ts

BUILD & RUNTIME VALIDATION
--------------------------
- Expo Go Android: onboarding, Google sign-in, dashboard, connect one provider.
- Android build: `expo prebuild --platform android` then `expo run:android` → ensure no runtime errors.
- Termux: device-flow for at least one provider; confirm tokens saved.

SECURITY POLICY
---------------
- No secrets in repo; no token logging; use SecureKeyStorage.

ACCEPTANCE CRITERIA
-------------------
- All tests pass; Android build runs; Termux device-flow verified; iOS untouched; all services route through AuthManager; docs cross-reference ZIP contents.

END OF BRIEF
